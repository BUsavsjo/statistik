<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Korrelationer mellan betyg och fr√•nvaro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --primary: #0d47a1;
      --radius: 8px;
      --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: #333;
    }

    h1,
    h2 {
      color: var(--primary);
      margin-top: 0;
    }

    .filter-bar {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      padding: 10px 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      z-index: 1000;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-group label {
      font-weight: 600;
    }

    .filter-group select {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-left: auto;
    }

    .tab {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
    }

    .tab.active {
      background: var(--primary);
      color: #fff;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 15px;
    }

    .dashboard {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 20px;
      flex: 1 1 200px;
    }

    .card .value {
      font-size: 2em;
      font-weight: 600;
    }

    .card .info {
      font-size: 0.875em;
      color: #555;
      margin-top: 0.5em;
    }

    .corr-low .value {
      color: #2e7d32;
    }

    .corr-medium .value {
      color: #f57c00;
    }

    .corr-high .value {
      color: #c62828;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .table-wrapper {
      overflow-x: auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #e3f2fd;
      cursor: pointer;
      position: relative;
    }

    .sort-indicator {
      margin-left: 5px;
      font-size: 0.8em;
    }

    .negativ {
      background-color: #ffebee;
    }

    .positiv {
      background-color: #e8f5e9;
    }

    .info-box {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 20px;
    }


    @media (max-width: 600px) {
      .filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .tabs {
        margin-left: 0;
      }

      table {
        min-width: 500px;
      }
    }
  </style>
</head>
<body>
  <div class="filter-bar">
    <div class="filter-group">
      <label for="lasar-select">L√§s√•r:</label>
      <select id="lasar-select">
        <option value="alla">Alla</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="arskurs-select">√Örskurs:</label>
      <select id="arskurs-select">
        <option value="alla">Alla</option>
        <option value="6">√Ök 6</option>
        <option value="9">√Ök 9</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="gender-select">K√∂n:</label>
      <select id="gender-select">
        <option value="alla">Alla</option>
        <option value="pojke">Pojke</option>
        <option value="flicka">Flicka</option>
      </select>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="ogiltig-section">Ogiltig</button>
      <button class="tab" data-tab="total-section">Total</button>
      <button class="tab" data-tab="merit-section">Merit</button>
    </div>
  </div>

  <div class="container">
    <h1>Korrelationer mellan betyg och fr√•nvaro</h1>
    <div class="dashboard" id="dashboard"></div>

    <div id="ogiltig-section" class="tab-content active">
      <h2>Ogiltig fr√•nvaro</h2>
      <div class="table-wrapper">
        <table id="ogiltig"></table>
      </div>
    </div>

    <div id="total-section" class="tab-content">
      <h2>Total fr√•nvaro</h2>
      <div class="table-wrapper">
        <table id="total"></table>
      </div>
    </div>

    <div id="merit-section" class="tab-content">
      <h2>Meritv√§rde</h2>
      <div class="table-wrapper">
        <table id="merit"></table>
      </div>
    </div>

    <div class="info-box">
      <p>Denna sida visar hur starkt elevers fr√•nvaro h√§nger ihop med deras betyg. Siffrorna visar ett s√• kallat <strong>korrelationsv√§rde</strong>, som kan ligga mellan <strong>-1</strong> och <strong>1</strong>.</p>

<p><strong>üìâ Negativ korrelation:</strong> Om v√§rdet √§r n√§ra <strong>-1</strong>, betyder det att mycket fr√•nvaro ofta leder till l√§gre betyg.</p>

<p><em>Exempel:</em> Om korrelationen i matematik √§r <strong>-0,82</strong>, betyder det att elever som √§r borta mycket ofta har l√•ga mattebetyg.</p>

<p><strong>üìà Positiv korrelation:</strong> Om v√§rdet √§r n√§ra <strong>+1</strong>, betyder det att mer fr√•nvaro h√§nger ihop med h√∂gre betyg ‚Äì vilket kan f√∂rekomma i vissa fall men √§r ovanligt.</p>

<p><em>Exempel:</em> Om korrelationen i musik √§r <strong>+0,25</strong>, kan det tyda p√• att elever med mer fr√•nvaro √§nd√• f√•r goda betyg ‚Äì men sambandet √§r svagt.</p>

<p><strong>‚öñÔ∏è Inget tydligt samband:</strong> Om v√§rdet √§r n√§ra <strong>0</strong>, finns inget tydligt samband mellan fr√•nvaro och betyg i det √§mnet.</p>

<p><em>Exempel:</em> Ett v√§rde p√• <strong>-0,05</strong> i samh√§llskunskap betyder att fr√•nvaron inte verkar p√•verka betygen n√§mnv√§rt.</p>

    </div>

  </div>

  <script>
    const LASAR = "2024-2025";
    const JSON_PATH = `json/${LASAR}`;
    let dataOgiltig = [], dataTotal = [], dataMerit = [];
    let medelMerit = [], medelMeritGender = [];
    const lasarSet = new Set();
    let cardOgiltig, cardTotal, cardMerit;
    let meritCards = [];

    function buildTable(data, tableId) {
      const table = document.getElementById(tableId);
      table.innerHTML = "";
      if (!data.length) return;
      const header = Object.keys(data[0]);
      const thead = table.createTHead();
      const row = thead.insertRow();
      header.forEach((key, i) => {
        const th = document.createElement("th");
        th.innerHTML = `${key}<span class="sort-indicator"></span>`;
        th.addEventListener("click", () => sortColumn(tableId, i));
        row.appendChild(th);
      });
      const tbody = table.createTBody();
      data.forEach(r => {
        const tr = tbody.insertRow();
        header.forEach(key => {
          const td = tr.insertCell();
          td.textContent = r[key];
          if (key === "Korrelation") {
            const v = parseFloat(r[key]);
            if (v > 0.2) td.classList.add("positiv");
            if (v < -0.2) td.classList.add("negativ");
          }
        });
      });
    }

    function sortColumn(tableId, col) {
      const table = document.getElementById(tableId);
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.rows);
      const isNum = !isNaN(parseFloat(rows[0].cells[col].textContent));
      const current = (table.dataset.sortCol == col) ? table.dataset.sortDir : "asc";
      const dir = current === "asc" ? "desc" : "asc";
      rows.sort((a, b) => {
        const A = a.cells[col].textContent;
        const B = b.cells[col].textContent;
        return isNum ? (parseFloat(A) - parseFloat(B)) * (dir === "asc" ? 1 : -1)
                     : A.localeCompare(B) * (dir === "asc" ? 1 : -1);
      });
      rows.forEach(r => tbody.appendChild(r));
      table.dataset.sortCol = col;
      table.dataset.sortDir = dir;
      table.querySelectorAll(".sort-indicator").forEach(i => i.textContent = "");
      const indicator = table.tHead.rows[0].cells[col].querySelector(".sort-indicator");
      indicator.textContent = dir === "asc" ? "‚ñ≤" : "‚ñº";
    }

    function filterData(data, year, grade, gender) {
      return data.filter(r =>
        (year === "alla" || r["L√§s√•r"] === year) &&
        (grade === "alla" || String(r["√Örskurs"]) === grade) &&
        (gender === "alla" || r["Gender"] === gender)
      );
    }

    function updateCards(ogiltigData, totalData, meritData) {
      const avgOgiltig = ogiltigData.length
        ? ogiltigData.reduce((a, r) => a + parseFloat(r.Korrelation || 0), 0) / ogiltigData.length
        : 0;
      const avgTotal = totalData.length
        ? totalData.reduce((a, r) => a + parseFloat(r.Korrelation || 0), 0) / totalData.length
        : 0;
      const avgMerit = meritData.length
        ? meritData.reduce((a, r) => a + parseFloat(r.Korrelation || 0), 0) / meritData.length
        : 0;
      const infoText = "Korrelationen visar styrkan i sambandet. V√§rden n√§ra 1 eller ‚àí1 betyder starkt samband.";
      if (!cardOgiltig)
        cardOgiltig = addCard(
          "Medel korrelation ‚Äì Ogiltig",
          "N/A",
          "",
          infoText
        );
      if (!cardTotal)
        cardTotal = addCard(
          "Medel korrelation ‚Äì Total",
          "N/A",
          "",
          infoText
        );
      if (!cardMerit)
        cardMerit = addCard(
          "Medel korrelation ‚Äì Meritv√§rde",
          "N/A",
          "",
          infoText
        );
      cardOgiltig.querySelector(".value").textContent = ogiltigData.length ? avgOgiltig.toFixed(2) : "N/A";
      cardOgiltig.className = `card ${getCorrClass(avgOgiltig)}`;
      cardTotal.querySelector(".value").textContent = totalData.length ? avgTotal.toFixed(2) : "N/A";
      cardTotal.className = `card ${getCorrClass(avgTotal)}`;
      cardMerit.querySelector(".value").textContent = meritData.length ? avgMerit.toFixed(2) : "N/A";
      cardMerit.className = `card ${getCorrClass(avgMerit)}`;
    }

    function updateMeritCards(year, grade, gender) {
      meritCards.forEach(c => c.remove());
      meritCards = [];
      const source = gender === "alla" ? medelMerit : medelMeritGender.filter(r => r.Gender === gender);
      source
        .filter(r => (grade === "alla" || String(r["√Örskurs"]) === grade) && (year === "alla" || !r["L√§s√•r"] || r["L√§s√•r"] === year))
        .forEach(r => {
          const value = (r["MedelMeritv√§rde"] ?? r["V√§rde"]).toFixed(2);
          const title = gender === "alla"
            ? `√Ök ${r["√Örskurs"]} ‚Äì Medel meritv√§rde`
            : `√Ök ${r["√Örskurs"]} ‚Äì Medel meritv√§rde (${r["Gender"]})`;
          meritCards.push(addCard(title, value));
        });
    }

    function updateTables() {
      const year = document.getElementById("lasar-select").value;
      const grade = document.getElementById("arskurs-select").value;
      const gender = document.getElementById("gender-select").value;
      const ogiltigData = filterData(dataOgiltig, year, grade, gender);
      const totalData = filterData(dataTotal, year, grade, gender);
      const meritData = filterData(dataMerit, year, grade, gender);
      buildTable(ogiltigData, "ogiltig");
      buildTable(totalData, "total");
      buildTable(meritData, "merit");
      updateCards(ogiltigData, totalData, meritData);
      updateMeritCards(year, grade, gender);
    }

    function updateYearDropdown() {
      const select = document.getElementById("lasar-select");
      select.innerHTML = '<option value="alla">Alla</option>';
      Array.from(lasarSet).sort().forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        select.appendChild(opt);
      });
    }

    function addCard(title, value, klass = "", info = "") {
      const card = document.createElement("div");
      card.className = `card ${klass}`;
      card.innerHTML = `<h3>${title}</h3><div class="value">${value}</div>${
        info ? `<div class="info">${info}</div>` : ""
      }`;
      document.getElementById("dashboard").appendChild(card);
      return card;
    }

    function getCorrClass(v) {
      const abs = Math.abs(v);
      if (abs >= 0.5) return "corr-high";
      if (abs >= 0.2) return "corr-medium";
      return "corr-low";
    }

    document.getElementById("lasar-select").addEventListener("change", updateTables);
    document.getElementById("arskurs-select").addEventListener("change", updateTables);
    document.getElementById("gender-select").addEventListener("change", e => readJson(e.target.value));
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab-content").forEach(sec => sec.classList.remove("active"));
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    async function readJson(gender) {
      const files = gender === "alla"
        ? [
            "ogiltig_franvaro_pct_ak6.json",
            "ogiltig_franvaro_pct_ak9.json",
            "total_franvaro_pct_ak6.json",
            "total_franvaro_pct_ak9.json",
            "meritvarde_ak6.json",
            "meritvarde_ak9.json",
            "medel_meritvarde.json"
          ]
        : [
            `ogiltig_franvaro_pct_ak6_${gender}.json`,
            `ogiltig_franvaro_pct_ak9_${gender}.json`,
            `total_franvaro_pct_ak6_${gender}.json`,
            `total_franvaro_pct_ak9_${gender}.json`,
            `meritvarde_ak6_${gender}.json`,
            `meritvarde_ak9_${gender}.json`,
            "medel_meritvarde_gender.json"
          ];
      try {
        const jsondata = await Promise.all(files.map(async f => {
          try {
            const res = await fetch(`${JSON_PATH}/${f}`);
            if (!res.ok) {
              console.error(`Kunde inte ladda ${f}`);
              addCard(`Kunde inte ladda ${f}`, "", "corr-high");
              return [];
            }
            return await res.json();
          } catch (err) {
            console.error(`Fel vid h√§mtning av ${f}`, err);
            addCard(`Fel vid h√§mtning av ${f}`, "", "corr-high");
            return [];
          }
        }));
        const assignGender = arr => arr.map(r => ({ ...r, Gender: gender }));
        dataOgiltig = assignGender(jsondata[0].concat(jsondata[1]));
        dataTotal = assignGender(jsondata[2].concat(jsondata[3]));
        dataMerit = assignGender(jsondata[4].concat(jsondata[5]));
        if (gender === "alla") {
          medelMerit = jsondata[6] || [];
          medelMeritGender = [];
        } else {
          medelMerit = [];
          medelMeritGender = jsondata[6] || [];
        }

        lasarSet.clear();
        [...dataOgiltig, ...dataTotal, ...dataMerit].forEach(r => lasarSet.add(r["L√§s√•r"]));
        updateYearDropdown();
        updateTables();
      } catch (error) {
        console.error("Fel vid l√§sning av JSON-data:", error);
        addCard("Fel", "Kunde inte ladda data", "corr-high");
      }
    }

    readJson(document.getElementById("gender-select").value);
  </script>
</body>
</html>

